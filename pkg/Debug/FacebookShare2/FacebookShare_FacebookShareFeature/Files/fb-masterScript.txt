var APP_Name = "FacebookShare";

var web;
var CurrentURL;


/*
 *	Page Loading (Sharepoint only)
 */
function runAfterEverythingElse() {
	ExecuteOrDelayUntilScriptLoaded(loadConstants, "sp.js");
}

if (typeof _spBodyOnLoadFunctionNames !== 'undefined') {
    _spBodyOnLoadFunctionNames.push("runAfterEverythingElse"); //equivalent to JQuery: $(document).ready(function ()... but for Sharepoint
}

/*
 *  Initialise Sharepoint constants
 */
function loadConstants() {
	var context = new SP.ClientContext.get_current();
	var site = context.get_site();
	context.load(site);
	web = context.get_web();
	context.load(web);
	context.executeQueryAsync(Function.createDelegate(this, this.onSuccess), Function.createDelegate(this, this.onFail));
}
function onSuccess(sender, args) {
	CurrentURL = web.get_url();
	modifyPage();
}
function onFail(sender, args) {
	console.log(args.get_message());
	CurrentURL = getRelativeUrl();
	modifyPage();
}

/*
 *	Utility (modify page, button, click...)
 */
function modifyPage() {
    $('body').prepend("<div id='fb-root'></div>");
    $(".ms-blog-commandSpace").each(function () {
        $(this).append(getButton());
    });
}

var position = 0;
function getButton() {
	var src = CurrentURL + "/" + APP_Name + "/Pages/fb-shareButton.html";

    //Need an overlay for the onclick event
    return "<span style='width:82px;height:20px;position:absolute;float:left;'>" +
                "<iframe id='iframeButton" + position + "' src='" + src + "' width='100%' height='100%' marginheight='0' frameborder='0' scrolling='no'></iframe>" +
                "<div style='top:0;left:0;width:100%;height:100%;position:absolute;' onclick='buttonClicked(" + (position++) + ")'></div>" +
            "</span>";
}


function buttonClicked(buttonNumber) {
    var text = $("div.ms-blog-postBody").contents()[buttonNumber].innerText;
    if (typeof text === 'undefined')
        text = $("div.ms-blog-postBody").contents()[buttonNumber].textContent; //Firefox/Opera compatibility

    document.getElementById('iframeButton' + buttonNumber).contentWindow.postMessage(APP_Name + ":" + text, '*');
}

function getRelativeUrl() {
    var absoluteUrl = document.URL;
    absoluteUrl = absoluteUrl.replace('https://', '');
    var parts = absoluteUrl.split('/');
    var relativeUrl = '/';
    for (var i = 1; i < parts.length-1; i++) {
        relativeUrl += parts[i] + '/';
    }
    return relativeUrl;
}